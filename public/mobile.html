<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Toronto Transit Live</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=91">

    <link rel="stylesheet" href="mobile.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-36MTR06FNC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-36MTR06FNC');
    </script>
</head>

<body>
    <div id="vanta-bg"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.25;">
    </div>

    <!-- MAP CONTAINER (Background) -->
    <div id="map-viewport">
        <!-- SVG Map Container - viewBox extended to 1600 to include Kennedy and Line 5 eastern terminal -->
        <svg id="map-root" viewBox="-150 0 1600 800" preserveAspectRatio="xMidYMid meet"
            xmlns="http://www.w3.org/2000/svg">
            <defs>
                <!-- Line 1 Glow -->
                <filter id="glow-l1" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="3" result="blur" />
                    <feFlood flood-color="#FFC425" flood-opacity="0.5" result="color" />
                    <feComposite in="color" in2="blur" operator="in" result="shadow" />
                    <feMerge>
                        <feMergeNode in="shadow" />
                        <feMergeNode in="SourceGraphic" />
                    </feMerge>
                </filter>
                <!-- Line 2 Glow -->
                <filter id="glow-l2" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="3" result="blur" />
                    <feFlood flood-color="#009639" flood-opacity="0.5" result="color" />
                    <feComposite in="color" in2="blur" operator="in" result="shadow" />
                    <feMerge>
                        <feMergeNode in="shadow" />
                        <feMergeNode in="SourceGraphic" />
                    </feMerge>
                </filter>
                <!-- Line 4 Glow -->
                <filter id="glow-l4" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="3" result="blur" />
                    <feFlood flood-color="#B11D8C" flood-opacity="0.5" result="color" />
                    <feComposite in="color" in2="blur" operator="in" result="shadow" />
                    <feMerge>
                        <feMergeNode in="shadow" />
                        <feMergeNode in="SourceGraphic" />
                    </feMerge>
                </filter>
                <!-- Line 5 Glow -->
                <filter id="glow-l5" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="3" result="blur" />
                    <feFlood flood-color="#F37021" flood-opacity="0.5" result="color" />
                    <feComposite in="color" in2="blur" operator="in" result="shadow" />
                    <feMerge>
                        <feMergeNode in="shadow" />
                        <feMergeNode in="SourceGraphic" />
                    </feMerge>
                </filter>
                <!-- Line 6 Glow -->
                <filter id="glow-l6" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="2" result="blur" />
                    <feFlood flood-color="#9ca3af" flood-opacity="0.4" result="color" />
                    <feComposite in="color" in2="blur" operator="in" result="shadow" />
                    <feMerge>
                        <feMergeNode in="shadow" />
                        <feMergeNode in="SourceGraphic" />
                    </feMerge>
                </filter>
                <!-- Alert Glow (Strong Red) -->
                <filter id="glow-alert" x="-500%" y="-500%" width="1000%" height="1000%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="15" result="blur" />
                    <feFlood flood-color="#ef4444" flood-opacity="1" result="color" />
                    <feComposite in="color" in2="blur" operator="in" result="shadow" />
                    <feMerge>
                        <feMergeNode in="shadow" />
                        <feMergeNode in="SourceGraphic" />
                    </feMerge>
                </filter>
                <!-- Delay Glow (Strong Orange) -->
                <filter id="glow-delay" x="-500%" y="-500%" width="1000%" height="1000%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="15" result="blur" />
                    <feFlood flood-color="#f59e0b" flood-opacity="1" result="color" />
                    <feComposite in="color" in2="blur" operator="in" result="shadow" />
                    <feMerge>
                        <feMergeNode in="shadow" />
                        <feMergeNode in="SourceGraphic" />
                    </feMerge>
                </filter>
            </defs>
            <g id="tracks-layer"></g>
            <g id="alerts-layer"></g>
            <g id="stations-layer"></g>
        </svg>
    </div>

    <!-- Subway Closed Overlay -->
    <div id="closed-overlay" class="closed-overlay hidden">
        <div class="closed-content">
            <i class="fas fa-moon closed-icon"></i>
            <h2 class="closed-title">Subway Closed</h2>
            <p class="closed-subtitle">Service resumes at <span id="reopen-time">6:00 AM</span></p>
            <div class="closed-divider"></div>
            <p class="closed-note">The subway is closed at this time</p>
            <div class="closed-hours">
                <div class="hours-title"><i class="fas fa-clock"></i> Daily Operating Hours</div>
                <div class="hours-row">
                    <span class="hours-day">Mon - Sat</span>
                    <span class="hours-time">6:00 AM – 2:00 AM</span>
                </div>
                <div class="hours-row">
                    <span class="hours-day">Sunday</span>
                    <span class="hours-time">8:00 AM – 2:00 AM</span>
                </div>
            </div>
            <button id="close-overlay-btn" class="close-overlay-btn"
                onclick="document.getElementById('closed-overlay').classList.add('hidden')">
                <i class="fas fa-map"></i> View Map
            </button>
        </div>
    </div>

    <!-- UI OVERLAY LAYER -->
    <div class="ui-layer">

        <!-- Top Bar -->
        <div class="top-bar">
            <!-- Search Pill -->

            <!-- Info Button to replace Search -->
            <div class="fab-stack" style="margin-left: 0; margin-right: auto; pointer-events: auto;">
                <div class="fab" id="btn-info" style="margin-bottom:0;">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span class="fab-icon"><i class="fas fa-info-circle"></i></span>
                </div>
                <!-- Theme Toggle Button -->
                <div class="fab" id="btn-theme">
                    <i class="fas fa-moon"></i>
                </div>

                <!-- Info Popup -->
                <div id="info-popup" class="layer-popup hidden" style="left: 60px; right: auto; top: 0;">
                    <div class="layer-popup-title">Toronto Transit Live <span
                            style="font-size: 11px; opacity: 1; font-weight: 600; margin-left: 6px; background: rgba(255,196,37,0.2); color: var(--l1-color); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(255,196,37,0.3);">ALPHA</span>
                    </div>

                    <!-- What is this app section -->
                    <div class="walkthrough-section">
                        <div class="walkthrough-title"><i class="fas fa-subway" style="color: var(--l1-color);"></i>
                            What is this app?</div>
                        <p class="walkthrough-text">
                            A real-time visualization of TTC subway alerts, outages, and delays on an interactive map.
                            See exactly where disruptions are happening on the network.
                        </p>
                    </div>

                    <!-- How to use section -->
                    <div class="walkthrough-section">
                        <div class="walkthrough-title"><i class="fas fa-hand-pointer"
                                style="color: var(--l2-color);"></i> How to use</div>
                        <ul class="walkthrough-list">
                            <li><strong>Map:</strong> Drag and pinch to explore</li>
                            <li class="walkthrough-visual-item">
                                <span class="visual-indicator red-indicator"></span>
                                <span><strong>Red:</strong> Service suspended</span>
                            </li>
                            <li class="walkthrough-visual-item">
                                <span class="visual-indicator orange-indicator"></span>
                                <span><strong>Orange:</strong> Delays / slow</span>
                            </li>
                            <li class="walkthrough-visual-item">
                                <span class="visual-indicator blue-indicator"></span>
                                <span><strong>Blue:</strong> Shuttle bus</span>
                            </li>
                            <li><strong>Alerts:</strong> View active alerts list</li>
                            <li><strong>Upcoming:</strong> Planned closures</li>
                        </ul>
                    </div>

                    <!-- Disclaimer section -->
                    <div class="walkthrough-section"
                        style="background: rgba(255, 183, 0, 0.1); border-radius: 8px; padding: 10px; margin-top: 8px;">
                        <div class="walkthrough-title" style="font-size: 12px;"><i class="fas fa-exclamation-triangle"
                                style="color: var(--l1-color);"></i> Disclaimer</div>
                        <p class="walkthrough-text" style="font-size: 11px; margin-top: 4px;">
                            This is a personal project, not an official TTC app. Data may be delayed or inaccurate.
                            Always verify with official TTC sources.
                        </p>
                    </div>

                    <div class="info-popup-footer">
                        Made by Faiz P • v1.2.0
                    </div>
                </div>
            </div>

            <!-- Clock Display -->
            <div id="clock-display" class="header-clock">
                <div class="clock-time">--:--</div>
                <div class="clock-date">---, --- --</div>
            </div>

            <!-- Status Indicator -->
            <div id="status-indicator" class="status-indicator loading">
                <i class="fas fa-eye status-eye"></i>
                <div class="status-spinner"></div>
                <span class="status-text">Loading</span>
                <div class="live-dot"></div>
            </div>

            <!-- Right Side FABs -->
            <div class="fab-stack">
                <div class="fab" id="btn-recenter"><i class="fas fa-crosshairs"></i></div>
                <div class="fab" id="btn-widget"
                    onclick="document.getElementById('widget-modal').classList.remove('hidden')">
                    <i class="fas fa-mobile-alt"></i>
                </div>
            </div>
        </div>

        <!-- Bottom UI (Sheets + Nav) -->
        <div class="bottom-ui">

            <!-- ALERTS SHEET -->
            <div id="sheet-alerts" class="sheet-container">
                <div class="sheet-handle-area">
                    <div class="sheet-handle"></div>
                </div>
                <div class="sheet-header">
                    <div class="sheet-title">Active Alerts</div>
                    <div class="sheet-subtitle">Real-time service disruptions</div>
                    <div class="line-filter" id="alerts-filter">
                        <button class="filter-btn active" data-line="all">All</button>
                        <button class="filter-btn bg-l1" data-line="1">1</button>
                        <button class="filter-btn bg-l2" data-line="2">2</button>
                        <button class="filter-btn bg-l4" data-line="4">4</button>
                        <button class="filter-btn bg-l5" data-line="5">5</button>
                        <button class="filter-btn bg-l6" data-line="6">6</button>
                    </div>
                </div>
                <div class="sheet-content" id="alerts-list">
                    <!-- Dynamic Alert Cards Here -->
                </div>
            </div>

            <!-- UPCOMING SHEET -->
            <div id="sheet-upcoming" class="sheet-container">
                <div class="sheet-handle-area">
                    <div class="sheet-handle"></div>
                </div>
                <div class="sheet-header">
                    <div class="sheet-title">Upcoming</div>
                    <div class="sheet-subtitle">Planned closures & maintenance</div>
                </div>
                <div class="sheet-content" id="upcoming-list">
                    <!-- Upcoming Cards Here -->
                </div>
            </div>

            <!-- BOTTOM NAVIGATION -->
            <div class="bottom-nav">
                <div class="nav-item active" data-tab="map">
                    <i class="fas fa-map"></i>
                    <span>Map</span>
                </div>
                <div class="nav-item" data-tab="alerts">
                    <div style="position: relative;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="badge-active" class="nav-badge hidden">0</span>
                    </div>
                    <span>Alerts</span>
                </div>
                <div class="nav-item" data-tab="upcoming">
                    <div style="position: relative;">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="badge-upcoming" class="nav-badge hidden">0</span>
                    </div>
                    <span>Upcoming</span>
                </div>
            </div>

        </div>
    </div>

    <!-- DISCLAIMER MODAL -->
    <div id="disclaimer-modal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:9999; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; padding:20px;">
        <div
            style="background:var(--sidebar-bg); border:1px solid var(--border-color); padding:20px; border-radius:12px; max-width:400px; width:100%; color:white; font-family:'Inter', sans-serif;">
            <h2 style="margin-bottom:12px; font-weight:700; font-size:18px; color: var(--l1-color);">
                <i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>Disclaimer
            </h2>
            <p style="font-size:14px; line-height:1.5; color:#d1d5db; margin-bottom:12px;">
                This is a <strong>personal project</strong> and not an official TTC map. There could be mistakes. This
                app is not affiliated with the Toronto Transit Commission (TTC).
            </p>
            <p style="font-size:14px; line-height:1.5; color:#d1d5db; margin-bottom:20px;">
                I made this because I was not able to easily know if an outage would affect me. I had to always look up
                a map to know, and this makes it easier to verify.
            </p>
            <button id="close-disclaimer"
                style="width:100%; padding:12px; background:var(--l4-color); border:none; border-radius:8px; color:white; font-weight:600; font-size:14px; cursor:pointer;">
                Close
            </button>
        </div>
    </div>

    <!-- MAIN APP SCRIPT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.net.min.js"></script>
    <script src="mobile.js?v=1768189900"></script>
    <!-- Disclaimer Banner -->
    <div id="disclaimer-banner" class="disclaimer-banner">
        <div class="disclaimer-content">
            <i class="fas fa-exclamation-triangle" style="color: #FFB700; margin-right: 12px; font-size: 16px;"></i>
            <span>This is a personal project. Data may be inaccurate. Not affiliated with the TTC. <strong
                    style="color: var(--l1-color);">Tap ⓘ to learn more.</strong></span>
        </div>
        <button id="btn-accept-disclaimer">I Understand</button>
    </div>

    <!-- Widget Setup Modal -->
    <div id="widget-modal" class="widget-modal hidden">
        <div class="widget-modal-content">
            <div class="widget-modal-header">
                <div class="widget-modal-title">
                    <i class="fas fa-mobile-alt" style="color: var(--l5-color);"></i>
                    iOS Widget Setup
                </div>
                <button class="widget-modal-close"
                    onclick="document.getElementById('widget-modal').classList.add('hidden')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="widget-modal-body">
                <div class="widget-step">
                    <div class="widget-step-number">1</div>
                    <div class="widget-step-content">
                        <div class="widget-step-title">Install Scriptable</div>
                        <p class="widget-step-text">Download <strong>Scriptable</strong> from the App Store. It's free
                            and lets you run custom widgets.</p>
                        <a href="https://apps.apple.com/app/scriptable/id1405459188" target="_blank"
                            class="widget-app-link">
                            <svg width="16" height="16" viewBox="0 0 800 800" fill="currentColor" style="flex-shrink:0">
                                <path
                                    d="M396.6,183.8l16.2-28c10-17.5,32.3-23.4,49.8-13.4s23.4,32.3,13.4,49.8L319.9,462.4h112.9c36.6,0,57.1,43,41.2,72.8H143c-20.2,0-36.4-16.2-36.4-36.4c0-20.2,16.2-36.4,36.4-36.4h92.8l118.8-205.9l-37.1-64.4c-10-17.5-4.1-39.6,13.4-49.8c17.5-10,39.6-4.1,49.8,13.4L396.6,183.8L396.6,183.8z M256.2,572.7l-35,60.7c-10,17.5-32.3,23.4-49.8,13.4S148,614.5,158,597l26-45C213.4,542.9,237.3,549.9,256.2,572.7L256.2,572.7z M557.6,462.6h94.7c20.2,0,36.4,16.2,36.4,36.4c0,20.2-16.2,36.4-36.4,36.4h-52.6l35.5,61.6c10,17.5,4.1,39.6-13.4,49.8c-17.5,10-39.6,4.1-49.8-13.4c-59.8-103.7-104.7-181.3-134.5-233c-30.5-52.6-8.7-105.4,12.8-123.3C474.2,318.1,509.9,380,557.6,462.6L557.6,462.6z" />
                            </svg>
                            App Store
                        </a>
                    </div>
                </div>

                <div class="widget-step">
                    <div class="widget-step-number">2</div>
                    <div class="widget-step-content">
                        <div class="widget-step-title">Add the Script</div>
                        <p class="widget-step-text">Open Scriptable, tap <strong>+</strong> to create a new script, then
                            paste the code below.</p>
                        <button id="btn-copy-widget-code" class="widget-copy-btn" onclick="copyWidgetCode()">
                            <i class="fas fa-copy"></i> Copy Script Code
                        </button>
                    </div>
                </div>

                <div class="widget-step">
                    <div class="widget-step-number">3</div>
                    <div class="widget-step-content">
                        <div class="widget-step-title">Name the Script</div>
                        <p class="widget-step-text">Tap the title at the top and rename it to <strong>TTC
                                Dashboard</strong> (or anything you like).</p>
                    </div>
                </div>

                <div class="widget-step">
                    <div class="widget-step-number">4</div>
                    <div class="widget-step-content">
                        <div class="widget-step-title">Add Widget to Home Screen</div>
                        <p class="widget-step-text">Long-press your home screen → tap <strong>+</strong> → search
                            <strong>Scriptable</strong> → choose <strong>Large</strong> widget.
                        </p>
                    </div>
                </div>

                <div class="widget-step">
                    <div class="widget-step-number">5</div>
                    <div class="widget-step-content">
                        <div class="widget-step-title">Configure</div>
                        <p class="widget-step-text">Long-press the widget → <strong>Edit Widget</strong> → select your
                            <strong>TTC Dashboard</strong> script.
                        </p>
                    </div>
                </div>

                <div class="widget-step-done">
                    <i class="fas fa-check-circle"></i>
                    <span>You're all set! The widget auto-updates — no need to re-copy the code.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function copyWidgetCode() {
            const btn = document.getElementById('btn-copy-widget-code');
            try {
                const res = await fetch('/ttc-widget.js');
                const code = await res.text();

                // Try modern clipboard API first
                let done = false;
                if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(code);
                        done = true;
                    } catch (_) { }
                }

                // Fallback: textarea select + copy (works on mobile Safari)
                if (!done) {
                    const ta = document.createElement('textarea');
                    ta.value = code;
                    ta.style.cssText = 'position:fixed;left:0;top:0;opacity:0;width:1px;height:1px';
                    document.body.appendChild(ta);
                    ta.focus();
                    ta.select();
                    ta.setSelectionRange(0, code.length);
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                }

                // Always show copied feedback
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-copy"></i> Copy Script Code';
                    btn.classList.remove('copied');
                }, 2500);
            } catch (e) {
                window.open('/ttc-widget.js', '_blank');
            }
        }
    </script>

</body>

</html>