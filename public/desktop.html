<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>TTC Service Alerts (Desktop)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="desktop.css">
</head>

<body>
    * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    }

    body {
    background-color: var(--bg-color);
    color: var(--text-main);
    font-family: 'Inter', sans-serif;
    overflow: hidden;
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    /* Fallback */
    height: 100dvh;
    position: fixed;
    /* Prevents mobile viewport bounce/scroll */
    touch-action: none;
    /* Disables default touch gestures globally */
    }

    #app-container {
    display: flex;
    width: 100%;
    height: 100%;
    }

    /* Sidebar */
    #sidebar {
    width: 220px;
    background-color: var(--sidebar-bg);
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-color);
    flex-shrink: 0;
    transition: transform 0.3s ease;
    position: relative;
    z-index: 100;
    }

    /* Mobile sidebar - hidden by default */
    @media (max-width: 768px) {
    #sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    transform: translateX(-100%);
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
    }

    #sidebar.open {
    transform: translateX(0);
    }
    }

    #sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 12px;
    }

    #sidebar-logo {
    font-size: 20px;
    font-weight: 800;
    color: white;
    display: flex;
    align-items: center;
    gap: 8px;
    }

    #sidebar-nav {
    flex: 1;
    padding: 12px 0;
    overflow-y: auto;
    }

    .nav-item {
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-muted);
    font-size: 14px;
    font-weight: 500;
    }

    .nav-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
    color: white;
    }

    .nav-item.active {
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
    border-left: 3px solid var(--l1-color);
    }

    .nav-item i {
    width: 20px;
    font-size: 16px;
    }

    .nav-item.expandable::after {
    content: "â€º";
    margin-left: auto;
    font-size: 18px;
    transition: transform 0.2s;
    }

    .nav-item.expandable.expanded::after {
    transform: rotate(90deg);
    }

    #sidebar-footer {
    padding: 16px;
    border-top: 1px solid var(--border-color);
    font-size: 11px;
    color: var(--text-muted);
    }

    #sidebar-footer a {
    color: var(--text-muted);
    text-decoration: none;
    margin-right: 12px;
    }

    #sidebar-footer a:hover {
    color: white;
    }

    /* Notification Badge */
    .nav-badge {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
    padding: 0 5px;
    animation: badge-pulse 2s ease-in-out infinite;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }

    .nav-badge.hidden {
    display: none;
    }

    @keyframes badge-pulse {

    0%,
    100% {
    transform: scale(1);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }

    50% {
    transform: scale(1.1);
    box-shadow: 0 4px 16px rgba(239, 68, 68, 0.6);
    }
    }

    .social-icons {
    margin-top: 12px;
    display: flex;
    gap: 12px;
    }

    .social-icons a {
    color: var(--text-muted);
    font-size: 16px;
    }

    /* Main Content */
    #main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    }

    #header {
    height: 60px;
    background-color: var(--sidebar-bg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    gap: 12px;
    }

    #hamburger-btn {
    display: none;
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    margin-right: 8px;
    }

    @media (max-width: 768px) {
    #hamburger-btn {
    display: block;
    }

    #header {
    padding: 0 12px;
    }
    }

    #search-container {
    flex: 1;
    max-width: 400px;
    margin: 0 20px;
    }

    @media (max-width: 768px) {
    #search-container {
    margin: 0 8px;
    max-width: none;
    }
    }

    #search-input {
    width: 100%;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px 16px 8px 40px;
    color: white;
    font-size: 14px;
    outline: none;
    }

    #search-input::placeholder {
    color: var(--text-muted);
    }

    #search-container {
    position: relative;
    }

    #search-container i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 14px;
    }

    #user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    cursor: pointer;
    }

    #viewport {
    flex: 1;
    overflow: hidden;
    position: relative;
    background-image: radial-gradient(circle at center, #1a1d24 1px, transparent 1px);
    background-size: 40px 40px;
    }

    svg {
    width: 100%;
    height: 100%;
    overflow: visible;
    touch-action: none;
    }

    #map-root {
    cursor: grab;
    transform-origin: 0 0;
    }

    #map-root:active {
    cursor: grabbing;
    }

    .track {
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
    stroke-width: 12px;
    transition: stroke 0.3s;
    }

    .track.line-1 {
    stroke: var(--l1-color);
    }

    .track.line-2 {
    stroke: var(--l2-color);
    }

    .track.line-4 {
    stroke: var(--l4-color);
    }

    .track.line-5 {
    stroke: var(--l5-color);
    stroke-dasharray: 30 15;
    stroke-linecap: butt !important;
    animation: line5Snake 1.5s linear infinite;
    }

    @keyframes line5Snake {
    0% {
    stroke-dashoffset: 0;
    }

    100% {
    stroke-dashoffset: 45;
    }
    }

    .track.line-6 {
    stroke: var(--l6-color);
    }

    .line-5-inner {
    stroke: var(--bg-color);
    stroke-width: 6px;
    fill: none;
    pointer-events: none;
    stroke-dasharray: 30 15;
    /* Match Line 5 */
    stroke-linecap: butt !important;
    /* Match Line 5 */
    animation: line5Snake 1.5s linear infinite;
    /* Match Line 5 to sync hollow effect */
    }

    .station-marker {
    cursor: pointer;
    transition: transform 0.2s;
    }

    .station-marker:hover {
    transform: scale(1.3);
    transform-box: fill-box;
    transform-origin: center;
    }

    /* Custom transfer stations - scale from center on hover like Bloor-Yonge */
    .spadina-inner,
    .st-george-inner {
    cursor: pointer;
    transition: transform 0.2s;
    }

    .spadina-inner:hover,
    .st-george-inner:hover {
    transform: scale(1.2);
    }

    .regular-station {
    fill: white;
    stroke: black;
    stroke-width: 1px;
    }

    .interchange-marker {
    stroke-width: 4px;
    fill: white;
    stroke: black;
    }

    .terminal-bubble {
    stroke: white;
    stroke-width: 3px;
    cursor: pointer;
    transition: transform 0.2s;
    }

    .terminal-text {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 800;
    text-anchor: middle;
    dominant-baseline: central;
    pointer-events: none;
    }

    .station-label {
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    fill: #9ca3af;
    pointer-events: none;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    transition: fill 0.2s;
    }

    .station-label.active {
    fill: #ffffff;
    font-size: 12px;
    font-weight: 700;
    }

    .terminal-label {
    font-size: 17px;
    font-weight: 800;
    fill: white;
    }

    .alert-base {
    fill: none;
    stroke: var(--alert-color);
    stroke-linecap: round;
    filter: drop-shadow(0 0 8px var(--alert-color));
    }

    .alert-base.delay {
    stroke: var(--delay-color);
    filter: drop-shadow(0 0 8px var(--delay-color));
    }

    .alert-base.shuttle {
    stroke: var(--shuttle-color);
    filter: drop-shadow(0 0 8px var(--shuttle-color));
    }

    .shuttle-outline {
    fill: none;
    stroke: var(--shuttle-color);
    stroke-width: 22px;
    stroke-linecap: round;
    stroke-linejoin: round;
    opacity: 0.9;
    filter: drop-shadow(0 0 8px var(--shuttle-color));
    }

    .flow-forward {
    stroke-width: 14px;
    opacity: 0.9;
    stroke-dasharray: 20, 20;
    animation: dash-fwd 1s linear infinite;
    }

    .flow-reverse {
    stroke-width: 14px;
    opacity: 0.9;
    stroke-dasharray: 20, 20;
    animation: dash-rev 1s linear infinite;
    }

    .pulse-solid {
    stroke-dasharray: none;
    animation: pulse-alert 1.5s ease-in-out infinite;
    }

    .station-alert-glow {
    fill: var(--alert-color);
    stroke: var(--alert-color);
    stroke-width: 1px;
    pointer-events: none;
    animation: station-pulse 1.5s ease-out infinite;
    }

    @keyframes dash-fwd {
    to {
    stroke-dashoffset: -40;
    }
    }

    @keyframes dash-rev {
    to {
    stroke-dashoffset: 40;
    }
    }

    @keyframes pulse-alert {
    0% {
    opacity: 0.6;
    stroke-width: 12px;
    }

    50% {
    opacity: 1;
    stroke-width: 16px;
    }

    100% {
    opacity: 0.6;
    stroke-width: 12px;
    }
    }

    @keyframes station-pulse {
    0% {
    opacity: 0.8;
    r: 10px;
    }

    100% {
    opacity: 0;
    r: 30px;
    }
    }

    /* Alerts Panel */
    #alerts-panel {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--bg-color);
    overflow-y: auto;
    padding: 20px;
    display: none;
    }

    #alerts-panel.active {
    display: block;
    }

    .alert-card {
    background-color: var(--sidebar-bg);
    border: 1px solid var(--border-color);
    border-left: 4px solid var(--alert-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    }

    .alert-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
    }

    .alert-line-badge {
    display: inline-block;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 14px;
    }

    .alert-line-badge.line-1 {
    background-color: var(--l1-color);
    color: black;
    }

    .alert-line-badge.line-2 {
    background-color: var(--l2-color);
    color: white;
    }

    .alert-line-badge.line-4 {
    background-color: var(--l4-color);
    color: white;
    }

    .alert-title {
    font-weight: 700;
    font-size: 16px;
    flex: 1;
    }

    .alert-meta {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 8px;
    }

    .alert-description {
    font-size: 14px;
    color: #d1d5db;
    line-height: 1.5;
    }

    .shuttle-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background-color: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-top: 8px;
    }

    /* Placeholder panels */
    .placeholder-panel {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--bg-color);
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 12px;
    }

    .placeholder-panel.active {
    display: flex;
    }

    .placeholder-panel i {
    font-size: 48px;
    color: var(--text-muted);
    }

    .placeholder-panel p {
    color: var(--text-muted);
    font-size: 18px;
    }

    /* Legend */
    #map-legend {
    position: absolute;
    bottom: 30px;
    right: 30px;
    background-color: rgba(24, 27, 33, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 12px 20px;
    backdrop-filter: blur(12px);
    z-index: 10000 !important;
    font-size: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    display: block;
    width: max-content;
    min-width: 0;
    }

    .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    /* Reduced spacing */
    padding: 4px 0;
    color: rgba(255, 255, 255, 0.9);
    white-space: nowrap;
    line-height: 1.2;
    }

    .legend-item svg {
    display: block;
    /* Removes baseline alignment quirks */
    }



    .legend-item:last-child {
    padding-bottom: 0;
    }



    /* Overlay for mobile sidebar */
    #sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 99;
    }

    #sidebar-overlay.active {
    display: block;
    }

    @media (max-width: 768px) {
    #sidebar {
    width: 180px;
    }
    }

    /* Status Indicator (Loading/Live) - Desktop */
    .status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-main);
    transition: all 0.3s ease;
    }

    .status-indicator.loading .status-spinner {
    display: block;
    }

    .status-indicator.loading .live-dot {
    display: none;
    }

    .status-indicator.loading .status-text {
    color: var(--text-muted);
    }

    .status-indicator.live .status-spinner {
    display: none;
    }

    .status-indicator.live .live-dot {
    display: block;
    }

    .status-indicator.live .status-text {
    color: #22c55e;
    }

    .status-indicator.live {
    border-color: rgba(34, 197, 94, 0.3);
    }

    .status-spinner {
    width: 12px;
    height: 12px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-top-color: var(--l1-color);
    border-radius: 50%;
    animation: spinnerRotate 0.8s linear infinite;
    }

    @keyframes spinnerRotate {
    to {
    transform: rotate(360deg);
    }
    }

    .live-dot {
    width: 8px;
    height: 8px;
    min-width: 8px;
    min-height: 8px;
    flex-shrink: 0;
    background: #22c55e;
    border-radius: 50%;
    animation: livePulse 2s ease-in-out infinite;
    }

    @keyframes livePulse {

    0%,
    100% {
    box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.6);
    }

    50% {
    box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
    }
    }
    </style>
    </head>

    <body>
        <div id="app-container">
            <!-- Overlay for mobile sidebar -->
            <div id="sidebar-overlay"></div>

            <!-- Sidebar -->
            <div id="sidebar">
                <div id="sidebar-header">
                    <i class="fas fa-subway" style="color: var(--l1-color); font-size: 24px;"></i>
                    <div id="sidebar-logo">TORONTO TRANSIT LIVE</div>
                </div>

                <div id="sidebar-nav">
                    <div class="nav-item active" data-tab="lines">
                        <i class="fas fa-route"></i>
                        <span>Lines</span>
                    </div>
                    <div class="nav-item" data-tab="alerts">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Alerts</span>
                    </div>
                    <div class="nav-item" data-tab="upcoming">
                        <i class="fas fa-clock"></i>
                        <span>Upcoming</span>
                        <span id="upcoming-badge" class="nav-badge hidden">0</span>
                    </div>
                    <div class="nav-item expandable" data-tab="about">
                        <i class="fas fa-info-circle"></i>
                        <span>About</span>
                    </div>
                </div>

                <div id="sidebar-footer">
                    <div><a href="#">About TTC</a><a href="#">Privacy Policy</a><a href="#">Contact</a></div>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-discord"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div id="main-content">
                <div id="header">
                    <button id="hamburger-btn" aria-label="Toggle menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div id="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" placeholder="Search...">
                    </div>
                    <!-- Status Indicator -->
                    <div id="status-indicator" class="status-indicator loading">
                        <div class="status-spinner"></div>
                        <span class="status-text">Loading</span>
                        <div class="live-dot"></div>
                    </div>
                    <div id="user-avatar"></div>
                </div>

                <div id="content-area" style="position: relative; flex: 1; overflow: hidden;">
                    <div id="viewport">
                        <svg id="ttc-svg" viewBox="0 0 1000 800" preserveAspectRatio="xMidYMid meet">
                            <g id="map-root">
                                <g id="tracks-layer"></g>
                                <g id="alerts-layer"></g>
                                <g id="stations-layer"></g>
                            </g>
                        </svg>
                    </div>

                    <!-- Legend -->
                    <div id="map-legend">
                        <div style="font-weight: 700; color: white; margin-bottom: 8px; font-size: 13px;">Legend</div>
                        <div class="legend-item">
                            <svg width="32" height="8" style="overflow: visible;">
                                <path d="M 0 4 L 32 4" class="alert-base pulse-solid"
                                    style="stroke-width: 6; opacity: 1; stroke-linecap: round;"></path>
                            </svg>
                            <span>No Service / Suspension</span>
                        </div>
                        <div class="legend-item">
                            <svg width="32" height="8" style="overflow: visible; position: relative; top: 1px;">
                                <path d="M 0 4 L 32 4" class="alert-base delay pulse-solid"
                                    style="stroke-width: 6; opacity: 1; stroke-linecap: round;"></path>
                            </svg>
                            <span style="position: relative; top: -1px;">Major Delays / Slow</span>
                        </div>
                        <div class="legend-item">
                            <svg width="32" height="8" style="overflow: visible;">
                                <path d="M 0 4 L 32 4" class="shuttle-outline"
                                    style="stroke-width: 3; opacity: 0.9; stroke-linecap: round;"></path>
                            </svg>
                            <span style="position: relative; top: -4px;">Shuttle Buses</span>
                        </div>
                    </div>

                    <!-- Alerts Panel -->
                    <div id="alerts-panel">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">Active Service Alerts</h2>
                        <div id="alerts-list"></div>
                    </div>

                    <!-- Upcoming Outages Panel -->
                    <div id="upcoming-panel" class="placeholder-panel">
                        <div style="width: 100%; max-width: 800px; padding: 20px; overflow-y: auto; max-height: 100%;">
                            <h2
                                style="font-size: 24px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-clock" style="color: var(--delay-color);"></i>
                                Upcoming Service Changes
                            </h2>
                            <div id="upcoming-list"></div>
                        </div>
                    </div>

                    <!-- Settings Placeholder -->
                    <!-- About Panel -->
                    <div id="about-panel" class="placeholder-panel">
                        <div
                            style="background:var(--sidebar-bg); border:1px solid var(--border-color); padding:40px; border-radius:12px; max-width:600px; color:white; text-align: left;">
                            <h2
                                style="margin-bottom:20px; font-weight:700; font-size:24px; color: var(--l1-color); display:flex; align-items:center; gap:12px;">
                                <i class="fas fa-exclamation-triangle"></i>Disclaimer
                            </h2>
                            <p style="font-size:16px; line-height:1.6; color:#d1d5db; margin-bottom:16px;">
                                This is a <strong>personal project</strong> and not an official TTC map. There could be
                                mistakes in the data or representation. This app is not affiliated with the Toronto
                                Transit
                                Commission (TTC).
                            </p>
                            <p style="font-size:16px; line-height:1.6; color:#d1d5db; margin-bottom:24px;">
                                <strong>Why I made this:</strong><br>
                                I made this dashboard because I was not able to easily know if a subway outage would
                                affect
                                my commute. I always had to look up a map to cross-reference alerts. This tool makes it
                                easier to verify if I am affected.
                            </p>
                            <div
                                style="margin-top:30px; padding-top:20px; border-top:1px solid var(--border-color); font-size:14px; color:var(--text-muted);">
                                Data provided by TTC Open Data.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            lucide.createIcons();
            let activeAlerts = [];
            let upcomingAlerts = [];
            let pollingInterval = null;
            let currentTab = 'lines';
            const mapRoot = document.getElementById('map-root');
            const viewport = document.getElementById('viewport');
            const tracksLayer = document.getElementById('tracks-layer');
            const stationsLayer = document.getElementById('stations-layer');
            const alertsLayer = document.getElementById('alerts-layer');
            let mapDraggable = null;

            // Navigation
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const hamburgerBtn = document.getElementById('hamburger-btn');

            // Toggle sidebar on mobile
            function toggleSidebar() {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('active');
            }

            hamburgerBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const tab = item.dataset.tab;
                    if (tab) {
                        switchTab(tab);
                        // Close sidebar on mobile after selecting a tab
                        if (window.innerWidth <= 768) {
                            toggleSidebar();
                        }
                    }
                });
            });

            function switchTab(tab) {
                currentTab = tab;

                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.tab === tab);
                });

                // Show/hide panels
                document.getElementById('viewport').style.display = (tab === 'lines') ? 'block' : 'none';
                document.getElementById('alerts-panel').classList.toggle('active', tab === 'alerts');
                document.getElementById('upcoming-panel').classList.toggle('active', tab === 'upcoming');
                document.getElementById('about-panel').classList.toggle('active', tab === 'about');
            }

            const rawMapData = [
                {
                    // Line 1 Update: Vertical from Finch West up to VMC
                    line: "1",
                    stations: [
                        { name: "Vaughan Metropolitan Centre", x: 300, y: 50, accessible: true }, // x changed to 300
                        { name: "Highway 407", x: 300, y: 80, accessible: true }, // x changed to 300
                        { name: "Pioneer Village", x: 300, y: 110, accessible: true }, // x changed to 300
                        { name: "York University", x: 300, y: 140, accessible: true }, // x changed to 300
                        { name: "Finch West", x: 300, y: 170, accessible: true }, // x changed to 300
                        { name: "Downsview Park", x: 320, y: 200, accessible: true },
                        { name: "Sheppard West", x: 340, y: 230, accessible: true },
                        { name: "Wilson", x: 360, y: 260, accessible: true },
                        { name: "Yorkdale", x: 360, y: 290, accessible: true },
                        { name: "Lawrence West", x: 360, y: 320, accessible: true },
                        { name: "Glencairn", x: 360, y: 350, accessible: false },
                        { name: "Cedarvale", x: 360, y: 380, accessible: true },
                        { name: "St Clair West", x: 360, y: 410, accessible: true },
                        { name: "Dupont", x: 360, y: 440, accessible: true },
                        { name: "Spadina", x: 360, y: 480, interchange: true, accessible: true },
                        { name: "St George", x: 400, y: 480, interchange: true, accessible: true },
                        { name: "Museum", x: 400, y: 550, accessible: false },
                        { name: "Queen's Park", x: 400, y: 580, accessible: true },
                        { name: "St Patrick", x: 400, y: 610, accessible: true },
                        { name: "Osgoode", x: 400, y: 640, accessible: true },
                        { name: "St Andrew", x: 400, y: 670, accessible: true },
                        { name: "Union", x: 520, y: 700, accessible: true },
                        { name: "King", x: 640, y: 670, accessible: false },
                        { name: "Queen", x: 640, y: 640, accessible: true },
                        { name: "TMU", x: 640, y: 610, accessible: true },
                        { name: "College", x: 640, y: 580, accessible: false },
                        { name: "Wellesley", x: 640, y: 550, accessible: true },
                        { name: "Bloor-Yonge", x: 640, y: 492, interchange: true, accessible: true },
                        { name: "Rosedale", x: 640, y: 460, accessible: false },
                        { name: "Summerhill", x: 640, y: 430, accessible: false },
                        { name: "St Clair", x: 640, y: 400, accessible: true },
                        { name: "Davisville", x: 640, y: 350, accessible: true },
                        { name: "Eglinton", x: 640, y: 380, accessible: true },
                        { name: "Lawrence", x: 640, y: 310, accessible: true },
                        { name: "York Mills", x: 640, y: 280, accessible: true },
                        { name: "Sheppard-Yonge", x: 640, y: 200, interchange: true, accessible: true },
                        { name: "North York Centre", x: 640, y: 150, accessible: true },
                        { name: "Finch", x: 640, y: 100, accessible: true }
                    ]
                },
                {
                    line: "2",
                    stations: [
                        { name: "Kipling", x: 30, y: 492, accessible: true },
                        { name: "Islington", x: 53, y: 492, accessible: false },
                        { name: "Royal York", x: 76, y: 492, accessible: true },
                        { name: "Old Mill", x: 99, y: 492, accessible: false },
                        { name: "Jane", x: 122, y: 492, accessible: true },
                        { name: "Runnymede", x: 145, y: 492, accessible: true },
                        { name: "High Park", x: 168, y: 492, accessible: false },
                        { name: "Keele", x: 191, y: 492, accessible: true },
                        { name: "Dundas West", x: 214, y: 492, accessible: true },
                        { name: "Lansdowne", x: 237, y: 492, accessible: false },
                        { name: "Dufferin", x: 260, y: 492, accessible: true },
                        { name: "Ossington", x: 283, y: 492, accessible: true },
                        { name: "Christie", x: 306, y: 492, accessible: false },
                        { name: "Bathurst", x: 329, y: 492, accessible: true },
                        { name: "Spadina", x: 360, y: 492, interchange: true, accessible: true },
                        { name: "St George", x: 400, y: 492, interchange: true, accessible: true },
                        { name: "Bay", x: 520, y: 492, accessible: true },
                        { name: "Bloor-Yonge", x: 640, y: 492, interchange: true, accessible: true },
                        { name: "Sherbourne", x: 670, y: 492, accessible: true },
                        { name: "Castle Frank", x: 695, y: 492, accessible: false },
                        { name: "Broadview", x: 720, y: 492, accessible: true },
                        { name: "Chester", x: 745, y: 492, accessible: true },
                        { name: "Pape", x: 770, y: 492, accessible: true },
                        { name: "Donlands", x: 795, y: 492, accessible: false },
                        { name: "Greenwood", x: 820, y: 492, accessible: false },
                        { name: "Coxwell", x: 845, y: 492, accessible: true },
                        { name: "Woodbine", x: 870, y: 492, accessible: true },
                        { name: "Main Street", x: 895, y: 492, accessible: true }, // Pivot point
                        { name: "Victoria Park", x: 920, y: 450, accessible: true }, // Diagonal start
                        { name: "Warden", x: 945, y: 410, accessible: false },
                        { name: "Kennedy", x: 970, y: 370, accessible: true }
                    ]
                },
                {
                    line: "4",
                    stations: [
                        { name: "Sheppard-Yonge", x: 640, y: 200, interchange: true, accessible: true },
                        { name: "Bayview", x: 690, y: 200, accessible: true },
                        { name: "Bessarion", x: 740, y: 200, accessible: true },
                        { name: "Leslie", x: 790, y: 200, accessible: true },
                        { name: "Don Mills", x: 840, y: 200, accessible: true }
                    ]
                },
                {
                    line: "5",
                    stations: [
                        { name: "Mount Dennis", x: 220, y: 380, accessible: true },
                        { name: "Kennedy", x: 970, y: 380, interchange: true, accessible: true }
                    ]
                },
                {
                    line: "6",
                    stations: [
                        { name: "Humber College", x: -125, y: 200, accessible: true },
                        { name: "Westmore", x: -100, y: 170, accessible: true },
                        { name: "Martin Grove", x: -75, y: 170, accessible: true },
                        { name: "Albion", x: -50, y: 170, accessible: true },
                        { name: "Stevenson", x: -25, y: 170, accessible: true },
                        { name: "Mount Olive", x: 0, y: 170, accessible: true },
                        { name: "Rowntree Mills", x: 25, y: 170, accessible: true },
                        { name: "Pearldale", x: 50, y: 170, accessible: true },
                        { name: "Duncanwoods", x: 75, y: 170, accessible: true },
                        { name: "Milvan Rumike", x: 100, y: 170, accessible: true },
                        { name: "Emery", x: 125, y: 170, accessible: true },
                        { name: "Signet Arrow", x: 150, y: 170, accessible: true },
                        { name: "Norfinch Oakdale", x: 175, y: 170, accessible: true },
                        { name: "Jane and Finch", x: 200, y: 170, accessible: true },
                        { name: "Driftwood", x: 225, y: 170, accessible: true },
                        { name: "Tobermory", x: 250, y: 170, accessible: true },
                        { name: "Sentinel", x: 275, y: 170, accessible: true },
                        { name: "Finch West", x: 300, y: 170, interchange: true, accessible: true }
                    ]
                }
            ];

            function initMap() {
                try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch (e) { }
                console.log("Checking for legend:", document.getElementById('map-legend'));
                renderTracks();
                renderStations();
                setupDragAndZoom();
                setupPinchZoom();
                fetchAlerts();
                fetchUpcomingAlerts();
                pollingInterval = setInterval(() => {
                    fetchAlerts();
                    fetchUpcomingAlerts();
                }, 60000);
            }

            function renderTracks() {
                tracksLayer.innerHTML = '';
                rawMapData.forEach(lineData => {
                    const d = getPathFromStations(lineData.stations, lineData.line);

                    // Base track
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", d); path.setAttribute("class", `track line-${lineData.line}`);
                    tracksLayer.appendChild(path);

                    // Add line number bubble on the left for Line 4
                    if (lineData.line === '4' && lineData.stations.length > 0) {
                        const firstStation = lineData.stations[0];
                        const labelX = firstStation.x - 120; // 120px left of first station
                        const labelY = firstStation.y;

                        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                        g.setAttribute("transform", `translate(${labelX}, ${labelY})`);

                        const bubble = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        bubble.setAttribute("r", 14);
                        bubble.setAttribute("fill", getLineColor('4'));
                        bubble.setAttribute("stroke", "white");
                        bubble.setAttribute("stroke-width", "3");
                        g.appendChild(bubble);

                        const num = document.createElementNS("http://www.w3.org/2000/svg", "text");
                        num.textContent = "4";
                        num.setAttribute("class", "terminal-text");
                        num.setAttribute("fill", "white");
                        g.appendChild(num);

                        tracksLayer.appendChild(g);
                    }

                    // Line 5 Hollow Effect using SVG Mask for True Transparency
                    if (lineData.line === '5') {
                        const maskId = "line-5-mask";
                        // Create Defs/Mask if not exists
                        let svg = tracksLayer.closest("svg");
                        if (svg) {
                            let defs = svg.querySelector("defs");
                            if (!defs) {
                                defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
                                svg.prepend(defs);
                            }

                            if (!document.getElementById(maskId)) {
                                const mask = document.createElementNS("http://www.w3.org/2000/svg", "mask");
                                mask.setAttribute("id", maskId);
                                // Mask coordinate system
                                mask.setAttribute("maskUnits", "userSpaceOnUse");

                                // Mask Base (White = Visible)
                                const maskBase = document.createElementNS("http://www.w3.org/2000/svg", "path");
                                maskBase.setAttribute("d", d);
                                maskBase.setAttribute("stroke", "white");
                                maskBase.setAttribute("stroke-width", "18");
                                maskBase.setAttribute("fill", "none");
                                mask.appendChild(maskBase);

                                // Mask Cutout (Black = Hidden/Transparent)
                                const maskCutout = document.createElementNS("http://www.w3.org/2000/svg", "path");
                                maskCutout.setAttribute("d", d);
                                maskCutout.setAttribute("stroke", "black");
                                maskCutout.setAttribute("stroke-width", "8"); // Width of the hole
                                maskCutout.setAttribute("fill", "none");
                                mask.appendChild(maskCutout);

                                defs.appendChild(mask);
                            }
                        }

                        // Apply mask to the main orange path
                        path.setAttribute("mask", `url(#${maskId})`);
                    }
                });
            }

            function getPathFromStations(stations, lineId) {
                let d = "";
                for (let i = 0; i < stations.length; i++) {
                    const s = stations[i];
                    if (i === 0) { d += `M ${s.x} ${s.y} `; continue; }
                    if (lineId === '1') {
                        if (s.name === 'Union') {
                            const prev = stations[i - 1];
                            if (prev && prev.name === 'St Andrew') { d += `Q 400 700, 520 700 `; continue; }
                        }
                        if (s.name === 'King') {
                            const prev = stations[i - 1];
                            if (prev && prev.name === 'Union') { d += `Q 640 700, 640 670 `; continue; }
                        }
                    }
                    d += `L ${s.x} ${s.y} `;
                }
                return d;
            }

            function getLineColor(lineId) { if (lineId === '1') return "#FFC425"; if (lineId === '2') return "#009639"; if (lineId === '4') return "#B5236B"; if (lineId === '5') return "#F37021"; if (lineId === '6') return "#9ca3af"; return "#ffffff"; }
            function getLineTextColor(lineId) { return (lineId === '1') ? "black" : "white"; }

            function renderStations() {
                stationsLayer.innerHTML = '';
                const allStations = [];
                rawMapData.forEach(l => {
                    const len = l.stations.length;
                    l.stations.forEach((s, i) => { allStations.push({ ...s, line: l.line, isTerminal: (i === 0 || i === len - 1) }); });
                });

                allStations.forEach(s => {
                    // Skip Spadina - handled by custom drawSpadinaTransfer
                    if (s.name === 'Spadina') return;
                    // Skip St George - handled by custom drawStGeorge
                    if (s.name === 'St George') return;
                    // Skip Line 2 Bloor-Yonge (Line 1 renders the icon)
                    if (s.line === '2' && s.name === 'Bloor-Yonge') return;

                    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    g.setAttribute("transform", `translate(${s.x}, ${s.y})`);

                    if (s.interchange) {
                        // Interchange style takes priority over terminal
                        const gIcon = document.createElementNS("http://www.w3.org/2000/svg", "g"); gIcon.setAttribute("class", "station-marker");
                        const sticker = document.createElementNS("http://www.w3.org/2000/svg", "circle"); sticker.setAttribute("r", 10); sticker.setAttribute("fill", "white"); gIcon.appendChild(sticker);
                        const blackRing = document.createElementNS("http://www.w3.org/2000/svg", "circle"); blackRing.setAttribute("r", 8); blackRing.setAttribute("fill", "black"); gIcon.appendChild(blackRing);
                        const whiteGap = document.createElementNS("http://www.w3.org/2000/svg", "circle"); whiteGap.setAttribute("r", 5.8); whiteGap.setAttribute("fill", "white"); gIcon.appendChild(whiteGap);
                        const blueBtn = document.createElementNS("http://www.w3.org/2000/svg", "circle"); blueBtn.setAttribute("r", 5); blueBtn.setAttribute("fill", "#528CCB"); gIcon.appendChild(blueBtn);
                        const iconPath = document.createElementNS("http://www.w3.org/2000/svg", "path"); iconPath.setAttribute("d", "M12 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m-.663 2.146a1.5 1.5 0 0 0-.47-2.115l-2.5-1.508a1.5 1.5 0 0 0-1.676.086l-2.329 1.75a.866.866 0 0 0 1.051 1.375L7.361 3.37l.922.71-2.038 2.445A4.73 4.73 0 0 0 2.628 7.67l1.064 1.065a3.25 3.25 0 0 1 4.574 4.574l1.064 1.063a4.73 4.73 0 0 0 1.09-3.998l1.043-.292-.187 2.991a.872.872 0 1 0 1.741.098l.206-4.121A1 1 0 0 0 12.224 8h-2.79zM3.023 9.48a3.25 3.25 0 0 0 4.496 4.496l1.077 1.077a4.75 4.75 0 0 1-6.65-6.65z"); iconPath.setAttribute("fill", "white"); iconPath.setAttribute("transform", "translate(-2.5, -2.5) scale(0.35)"); gIcon.appendChild(iconPath);
                        g.appendChild(gIcon);
                    } else if (s.accessible) {
                        const gIcon = document.createElementNS("http://www.w3.org/2000/svg", "g"); gIcon.setAttribute("class", "station-marker");
                        const outerRing = document.createElementNS("http://www.w3.org/2000/svg", "circle"); outerRing.setAttribute("r", "4.5"); outerRing.setAttribute("fill", "black"); gIcon.appendChild(outerRing);
                        const midRing = document.createElementNS("http://www.w3.org/2000/svg", "circle"); midRing.setAttribute("r", "3.8"); midRing.setAttribute("fill", "white"); gIcon.appendChild(midRing);
                        const innerCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle"); innerCircle.setAttribute("r", "3"); innerCircle.setAttribute("fill", "#528CCB"); gIcon.appendChild(innerCircle);
                        const iconPath = document.createElementNS("http://www.w3.org/2000/svg", "path"); iconPath.setAttribute("d", "M12 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m-.663 2.146a1.5 1.5 0 0 0-.47-2.115l-2.5-1.508a1.5 1.5 0 0 0-1.676.086l-2.329 1.75a.866.866 0 0 0 1.051 1.375L7.361 3.37l.922.71-2.038 2.445A4.73 4.73 0 0 0 2.628 7.67l1.064 1.065a3.25 3.25 0 0 1 4.574 4.574l1.064 1.063a4.73 4.73 0 0 0 1.09-3.998l1.043-.292-.187 2.991a.872.872 0 1 0 1.741.098l.206-4.121A1 1 0 0 0 12.224 8h-2.79zM3.023 9.48a3.25 3.25 0 0 0 4.496 4.496l1.077 1.077a4.75 4.75 0 0 1-6.65-6.65z"); iconPath.setAttribute("fill", "white"); iconPath.setAttribute("transform", "translate(-2, -2) scale(0.25)"); gIcon.appendChild(iconPath);
                        g.appendChild(gIcon);

                        // Terminals that are accessible (e.g. Vaughan, Finch, Kipling) - will get detached badge below
                    } else {
                        const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle"); dot.setAttribute("r", 4); dot.setAttribute("class", "station-marker regular-station"); dot.setAttribute("fill", "white"); dot.setAttribute("stroke", "black"); dot.setAttribute("stroke-width", "1");
                        g.appendChild(dot);
                    }

                    // Detached Terminal Badges (Line Number to the side)
                    if (s.isTerminal) {
                        const badgeG = document.createElementNS("http://www.w3.org/2000/svg", "g");
                        let bdx = 0, bdy = 0;

                        // Desktop specific positioning logic
                        if (s.name === "Vaughan Metropolitan Centre") { bdx = 0; bdy = -25; } // Top
                        else if (s.name === "Finch") { bdx = 0; bdy = -25; } // Top
                        else if (s.name === "Kipling") { bdx = -97; bdy = 0; } // Moved another 7px left per user request (was -90)
                        else if (s.name === "Kennedy") {
                            if (s.line === '2') { bdx = 90; bdy = 0; } // Right (after text)
                            else if (s.line === '5') { bdx = 120; bdy = 0; } // Farther Right (after Line 2 badge)
                        }
                        else if (s.name === "Sheppard-Yonge" && s.line === '4') { bdx = -25; bdy = 0; } // Left of Line 4 start
                        else if (s.name === "Don Mills") { bdx = 25; bdy = 0; } // Right
                        else if (s.name === "Mount Dennis") { bdx = -25; bdy = 0; } // Left
                        else if (s.name === "Humber College") { bdx = 0; bdy = 25; } // Bottom
                        else if (s.name === "Finch West" && s.line === '6') { bdx = 25; bdy = 0; } // Right

                        // Only render badge if we set a position (filters out non-visible terminals like Line 1 Sheppard-Yonge)
                        if (bdx !== 0 || bdy !== 0) {
                            badgeG.setAttribute("transform", `translate(${bdx}, ${bdy})`);

                            const badgeCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                            badgeCircle.setAttribute("r", 12);
                            badgeCircle.setAttribute("fill", getLineColor(s.line));
                            badgeCircle.setAttribute("stroke", "white");
                            badgeCircle.setAttribute("stroke-width", 2);
                            badgeG.appendChild(badgeCircle);

                            const badgeText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                            badgeText.textContent = s.line;
                            badgeText.setAttribute("class", "terminal-text");
                            badgeText.setAttribute("fill", s.line === '1' ? 'black' : 'white');
                            badgeText.setAttribute("dy", 1);
                            badgeText.setAttribute("text-anchor", "middle");
                            badgeText.setAttribute("dominant-baseline", "middle");
                            badgeG.appendChild(badgeText);

                            g.appendChild(badgeG);
                        }
                    }

                    const isDup = (s.line === '4' && s.name === "Sheppard-Yonge") ||
                        (s.line === '1' && ["Spadina", "St George"].includes(s.name)) ||
                        (s.line === '2' && ["Spadina", "St George", "Bloor-Yonge"].includes(s.name)) ||  // Skip Line 2 duplicates
                        (s.line === '5' && s.name === "Kennedy") ||  // Kennedy is rendered by Line 2
                        (s.line === '1' && s.name === "Finch West");  // Finch West is on Line 6

                    if (!isDup) {
                        const text = document.createElementNS("http://www.w3.org/2000/svg", "text"); text.textContent = s.name;
                        // Apply bold class for terminal stations
                        if (s.isTerminal || s.name === "Spadina" || s.name === "St George" || s.name === "Bloor-Yonge" || s.name === "Union") {
                            text.setAttribute("class", "station-label terminal-label");
                        } else {
                            text.setAttribute("class", "station-label");
                        }

                        let tx = 12, ty = 4, rot = 0, anchor = "start";

                        // Line 6 label positioning (to avoid overlap with tracks)
                        if (s.line === '6') {
                            if (s.name === "Humber College") {
                                rot = 0; tx = 25; ty = 5; anchor = "start";  // Name on Right, Badge Bottom
                            } else if (s.name === "Finch West") {
                                rot = 0; tx = 20; ty = 5; anchor = "start"; // Name on Right
                            } else {
                                // Stations to show on TOP (above track)
                                const topStations = ["Westmore", "Martin Grove", "Albion", "Stevenson", "Mount Olive", "Rowntree Mills", "Pearldale", "Duncanwoods"];
                                if (topStations.includes(s.name)) {
                                    rot = -45; tx = 5; ty = -10; anchor = "start";
                                } else {
                                    rot = 45; tx = 5; ty = 10; anchor = "start";
                                }
                            }
                        }
                        // Existing Line 1, 2, 4 positioning
                        else if (s.line === '1' && (s.name === "Downsview Park" || s.name === "Sheppard West")) { tx = 15; ty = 4; anchor = "start"; }
                        else if (s.line === '1' && (s.name === "Sheppard-Yonge" || s.name === "Wellesley" || s.name === "St Andrew")) { tx = -15; ty = 4; anchor = "end"; }
                        else if (s.line === '1' && s.name === "Bloor-Yonge") { tx = -15; ty = -15; anchor = "end"; }  // Above Line 2, left of Line 1
                        else if (s.line === '1' && s.name === "Union") { tx = 0; ty = 25; anchor = "middle"; }
                        else if (s.line === '4' || s.y === 490) { rot = 45; tx = 10; ty = 10; anchor = "start"; }
                        else if (s.line === '2') {
                            if (s.name === 'St George') {
                                rot = -45; tx = 10; ty = -10; anchor = "start";
                            } else if (s.name === 'Spadina') {
                                rot = 45; tx = -10; ty = -10; anchor = "end";
                            } else if (s.name === 'Keele') {
                                rot = 45; tx = 10; ty = 10; anchor = "start";
                            } else {
                                rot = 45; tx = 10; ty = 10; anchor = "start";
                            }
                        }
                        else if (s.line === '1' && s.x < 360) { tx = -12; ty = 4; anchor = "end"; }
                        else if (s.line === '1' && s.x >= 640 && s.y < 500) { tx = 12; ty = 4; anchor = "start"; }

                        // Custom overrides for specific stations
                        if (s.name === "Vaughan Metropolitan Centre") { tx = 15; ty = 5; rot = 0; anchor = "start"; } // Straight, Right of track
                        else if (s.name === "Finch") { tx = 15; ty = 5; rot = 0; anchor = "start"; } // Straight, Right of track
                        else if (s.name === "Kipling") { rot = 0; tx = -18; ty = 5; anchor = "end"; } // Moved 10px to the left per user request (was -8)
                        else if (s.name === "Kennedy") {
                            if (s.line === '2') { rot = 0; tx = 25; ty = 5; anchor = "start"; } // Straight, Right of badge (Line 2)
                        }
                        else if (s.name === "Sheppard-Yonge" && s.line === '4') {
                            rot = 0; tx = 15; ty = -15; anchor = "start"; // Above line/badge
                        }
                        else if (s.name === "Don Mills") { rot = 0; tx = 25; ty = 5; anchor = "start"; } // Straight, Right of badge
                        else if (s.name === "Mount Dennis") { rot = 0; tx = -25; ty = 5; anchor = "end"; } // Straight, Left of badge
                        else if (s.name === "Finch West" && s.line === '6') { rot = 0; tx = 25; ty = 5; anchor = "start"; } // Label right of badge (Line 6)

                        text.setAttribute("transform", `translate(${tx}, ${ty}) rotate(${rot})`);
                        text.setAttribute("text-anchor", anchor);
                        g.appendChild(text);
                    }
                    stationsLayer.appendChild(g);
                });

                // Custom station rendering
                drawSpadinaTransfer();
                <script src="desktop.js"></script>
    </body>

</html>